global
    maxconn 2048
    tune.ssl.default-dh-param 2048
    tune.maxrewrite 4096
    log stdout  format raw  local0  debug

defaults
    log     global
    option  httplog
    option  dontlognull
    timeout connect 5000
    timeout client  50000
    timeout server  50000

frontend fe_p1_http
    bind *:80
    mode http
    option httplog
    stats enable
    stats uri /stats
    stats refresh 10s
    stats admin if LOCALHOST

    use_backend %[path,map_beg(/usr/local/etc/haproxy/maps/routes.map,be_p1web)]

frontend fe_p1_https
    bind *:443 ssl crt /etc/haproxy/pem/p1app.pem user nobody
    mode http
    option httplog
    stats enable
    stats uri /stats
    stats refresh 10s
    stats admin if LOCALHOST
    option forwardfor
    http-request set-header X-Forwarded-Port %[dst_port]
    http-request set-header X-Forwarded-For %[src]
    http-request set-header X-Forwarded-Proto https

    use_backend %[path,map_beg(/usr/local/etc/haproxy/maps/routes.map,be_p1web)]

backend be_p1web
    mode http
    http-request set-header X-Forwarded-Port %[dst_port]
    http-request add-header X-Forwarded-Proto https if { ssl_fc }
    server p1webapp p1webapp:3000

backend be_authapi
    mode http
    http-request set-header X-Forwarded-Port %[dst_port]
    http-request add-header X-Forwarded-Proto https if { ssl_fc }
    server authapi authapi:3000

backend be_securityapi
    mode http
    http-request set-header X-Forwarded-Port %[dst_port]
    http-request add-header X-Forwarded-Proto https if { ssl_fc }
    server securityapi securityapi:3000
